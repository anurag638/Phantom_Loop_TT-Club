<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Phantom Loop TT Club</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- EmailJS Configuration -->
    <script src="emailjs-config.js"></script>
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <div class="logo-container"></div>
                <span class="navbar-brand-text">Phantom Loop TT Club</span>
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="welcomeText">
                    Welcome, Admin
                </span>
                <a class="btn btn-outline-danger btn-sm" href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-white mb-4">
                    <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                </h1>
                <div class="alert alert-success">
                    <i class="fas fa-database"></i>
                    <strong>Database Connected:</strong> All data is automatically synced across all devices. Players can login from anywhere with their credentials.
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-fire"></i>
                    <strong>New Streak Management:</strong> 
                    Use the <i class="fas fa-fire"></i> button for quick streak adjustments. 
                    Or click <strong>"Bulk Streak Adj"</strong> to reset/add to all players at once. 
                    Positive streaks = winning streaks, negative streaks = losing streaks.
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsCards">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="row">
            <!-- Player Management -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i> Player Management
                        </h5>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                            <i class="fas fa-plus"></i> Add New Player
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="playersTable">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Name</th>
                                        <th>Wins</th>
                                        <th>Losses</th>
                                        <th>Win Rate</th>
                                        <th>Streak</th>
                                        <th>Attendance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Players will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Match Form -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-plus"></i> Add Match Result
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="addMatchForm">
                            <div class="mb-3">
                                <label class="form-label">Player 1</label>
                                <select class="form-select" name="player1_id" required>
                                    <option value="">Select Player 1</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Player 2</label>
                                <select class="form-select" name="player2_id" required>
                                    <option value="">Select Player 2</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Score 1</label>
                                    <input type="number" class="form-control" name="player1_score" min="0" max="5" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Score 2</label>
                                    <input type="number" class="form-control" name="player2_score" min="0" max="5" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Winner</label>
                                <select class="form-select" name="winner_id" required>
                                    <option value="">Select Winner</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Match Date</label>
                                <input type="date" class="form-control" name="match_date" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i> Add Match
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Matches -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Recent Matches
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" id="showMoreMatchesBtn" style="display: none;">
                                <i class="fas fa-plus"></i> Show More
                            </button>
                            <button class="btn btn-sm btn-outline-warning" id="bulkStreakAdjustBtn" title="Bulk Streak Adjustment">
                                <i class="fas fa-fire"></i> Bulk Streak Adj
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="deleteAllMatchesBtn" style="display: none;">
                                <i class="fas fa-trash"></i> Delete All Matches
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="recentMatchesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Player 1</th>
                                        <th>Score</th>
                                        <th>Player 2</th>
                                        <th>Winner</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Matches will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div class="modal fade" id="addPlayerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> Add New Player
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPlayerForm">
                        <div class="mb-3">
                            <label class="form-label">Player Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Initial Rank</label>
                            <input type="number" class="form-control" name="rank" min="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="addPlayerBtn">
                        <i class="fas fa-plus"></i> Add Player
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Modal -->
    <div class="modal fade" id="editPlayerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit"></i> Edit Player
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPlayerForm">
                        <input type="hidden" name="player_id" id="editPlayerId">
                        <div class="mb-3">
                            <label class="form-label">Player Name</label>
                            <input type="text" class="form-control" name="name" id="editPlayerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rank</label>
                            <input type="number" class="form-control" name="rank" id="editPlayerRank" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Wins</label>
                            <input type="number" class="form-control" name="wins" id="editPlayerWins" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Losses</label>
                            <input type="number" class="form-control" name="losses" id="editPlayerLosses" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Streak</label>
                            <input type="number" class="form-control" name="current_streak" id="editPlayerStreak" required>
                            <small class="form-text text-muted">Positive numbers for winning streaks, negative for losing streaks</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updatePlayerBtn">
                        <i class="fas fa-save"></i> Update Player
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js?v=24"></script>
    <script>
        // Check authentication
        if (!TTC.checkAuth()) {
            // Redirect will happen in checkAuth
        }

        // Initialize dashboard
        function initDashboard() {
            const user = TTC.getCurrentUser();
            document.getElementById('welcomeText').textContent = `Welcome, ${user.username} (${user.role})`;
            
            loadDashboardData();
            setupEventListeners();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // If data has already been loaded, render immediately
            initDashboard();
        });

        // Also re-render once Firebase has finished initial load
        document.addEventListener('ttc:dataLoaded', function() {
            initDashboard();
        });
        
        // Listen for rankings updates
        document.addEventListener('ttc:rankingsUpdated', function() {
            loadPlayers(); // Refresh only the players table
        });
        
        // Listen for data updates
        document.addEventListener('ttc:dataUpdated', function() {
            loadDashboardData(); // Refresh everything
        });

        function loadDashboardData() {
            loadStats();
            loadPlayers();
            loadRecentMatches();
            populatePlayerSelects();
        }

        function loadStats() {
            const players = TTC.getPlayers();
            const matches = TTC.getMatches();
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate present today - check both current status and historical record
            const presentToday = players.filter(p => {
                const currentStatus = p.attendance_status === 'Present';
                const historicalStatus = p.attendance_history && p.attendance_history[today] === 'Present';
                return currentStatus || historicalStatus;
            }).length;
            
            // Calculate total attendance days across all players
            const totalAttendanceDays = players.reduce((total, p) => {
                const history = p.attendance_history || {};
                return total + Object.values(history).filter(status => status === 'Present').length;
            }, 0);
            
            const avgWinRate = players.length > 0 ? 
                (players.reduce((sum, p) => sum + p.win_rate, 0) / players.length) : 0;

            const statsHtml = `
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number">${players.length}</div>
                        <div class="stat-label">Total Players</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-number">${matches.length}</div>
                        <div class="stat-label">Total Matches</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-number">${presentToday}</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-number">${totalAttendanceDays}</div>
                        <div class="stat-label">Total Attendance Days</div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsCards').innerHTML = statsHtml;
        }

        function loadPlayers() {
            const players = TTC.getPlayers();
            const tbody = document.querySelector('#playersTable tbody');
            
            tbody.innerHTML = players.map(player => {
                // Calculate total attendance days
                const attendanceHistory = player.attendance_history || {};
                const totalAttendanceDays = Object.values(attendanceHistory).filter(status => status === 'Present').length;
                
                return `
                <tr data-player-id="${player.id}">
                    <td>
                        <span class="badge badge-info">${player.rank}</span>
                    </td>
                    <td>
                        <strong>${player.name}</strong>
                    </td>
                    <td>${player.wins}</td>
                    <td>${player.losses}</td>
                    <td>${TTC.formatWinRate(player.win_rate)}%</td>
                    <td>
                        ${player.current_streak > 0 ? 
                            `<span class="badge badge-success">+${player.current_streak}</span>` :
                            player.current_streak < 0 ?
                            `<span class="badge badge-danger">${player.current_streak}</span>` :
                            `<span class="badge badge-warning">0</span>`
                        }
                    </td>
                    <td>
                        <div class="attendance-controls">
                            <div class="current-status mb-2">
                                <span class="badge ${player.attendance_status === 'Present' ? 'bg-success' : 'bg-danger'}">
                                    ${player.attendance_status}
                                </span>
                                <small class="text-muted d-block">Last: ${TTC.formatDate(player.last_seen)}</small>
                            </div>
                            <select class="form-select form-select-sm attendance-select" 
                                    data-player-id="${player.id}" 
                                    style="width: auto; margin-bottom: 5px;">
                                <option value="Present" ${player.attendance_status === 'Present' ? 'selected' : ''}>Present</option>
                                <option value="Absent" ${player.attendance_status === 'Absent' ? 'selected' : ''}>Absent</option>
                            </select>
                            <div class="attendance-date-controls" style="display: none;">
                                <input type="date" class="form-control form-control-sm attendance-date" 
                                       data-player-id="${player.id}" 
                                       value="${new Date().toISOString().split('T')[0]}" 
                                       style="width: auto; margin-bottom: 5px;">
                                <button class="btn btn-sm btn-primary mark-attendance-btn" 
                                        data-player-id="${player.id}">Mark</button>
                            </div>
                            <div class="attendance-stats mt-1">
                                <small class="text-muted">Total: ${totalAttendanceDays} days</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary edit-player-btn" 
                                    data-player-id="${player.id}"
                                    data-player-name="${player.name}"
                                    data-player-rank="${player.rank}"
                                    title="Edit Player">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success adjust-streak-btn" 
                                    data-player-id="${player.id}"
                                    data-player-name="${player.name}"
                                    title="Quick Adjust Streak">
                                <i class="fas fa-fire"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-player-btn" 
                                    data-player-id="${player.id}"
                                    data-player-name="${player.name}"
                                    title="Delete Player">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
            
            // Re-attach event listeners after table refresh
            setupEventListeners();
        }

        let showingAllMatches = false;
        const INITIAL_MATCHES_LIMIT = 5;

        function loadRecentMatches() {
            const allMatches = TTC.getMatches();
            console.log('Loading recent matches, total matches:', allMatches.length);
            const matchesToShow = showingAllMatches ? allMatches : allMatches.slice(0, INITIAL_MATCHES_LIMIT);
            const tbody = document.querySelector('#recentMatchesTable tbody');
            const showMoreBtn = document.getElementById('showMoreMatchesBtn');
            
            if (allMatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No recent matches found.</td></tr>';
                showMoreBtn.style.display = 'none';
                const deleteAllBtn = document.getElementById('deleteAllMatchesBtn');
                if (deleteAllBtn) {
                    deleteAllBtn.style.display = 'none';
                }
                return;
            }
            
            tbody.innerHTML = matchesToShow.map(match => `
                <tr data-match-id="${match.id}">
                    <td>${TTC.formatDate(match.match_date)}</td>
                    <td>${TTC.getPlayerName(match.player1_id)}</td>
                    <td>
                        <span class="badge badge-info">
                            ${match.player1_score} - ${match.player2_score}
                        </span>
                    </td>
                    <td>${TTC.getPlayerName(match.player2_id)}</td>
                    <td>
                        <span class="badge badge-success">${TTC.getPlayerName(match.winner_id)}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-match-btn" 
                                data-match-id="${match.id}"
                                data-player1-id="${match.player1_id}"
                                data-player2-id="${match.player2_id}"
                                data-winner-id="${match.winner_id}"
                                title="Delete Match">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Show/hide buttons based on total matches
            if (allMatches.length > INITIAL_MATCHES_LIMIT) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.innerHTML = showingAllMatches ? 
                    '<i class="fas fa-minus"></i> Show Less' : 
                    '<i class="fas fa-plus"></i> Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }
            
            // Show/hide "Delete All Matches" button
            const deleteAllBtn = document.getElementById('deleteAllMatchesBtn');
            if (allMatches.length > 0) {
                deleteAllBtn.style.display = 'block';
            } else {
                deleteAllBtn.style.display = 'none';
            }
        }

        function toggleShowMoreMatches() {
            showingAllMatches = !showingAllMatches;
            loadRecentMatches();
        }

        async function deleteAllMatches() {
            const allMatches = TTC.getMatches();
            if (allMatches.length === 0) {
                TTC.showAlert('No matches to delete', 'info');
                return;
            }

            if (!confirm(`Are you sure you want to delete ALL ${allMatches.length} matches? This action cannot be undone and will reset all player statistics.`)) {
                return;
            }

            TTC.showLoading();
            
            try {
                const result = await TTC.deleteAllMatches();
                if (result) {
                    TTC.showAlert('All matches deleted successfully!', 'success');
                    loadDashboardData();
                } else {
                    TTC.showAlert('Failed to delete all matches. Please try again.', 'danger');
                }
            } catch (error) {
                console.error('Error deleting all matches:', error);
                TTC.showAlert('Failed to delete all matches: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }

        async function deleteMatch(matchId, player1Id, player2Id, winnerId) {
            if (!confirm('Are you sure you want to delete this match? This will update the affected players\' statistics.')) {
                return;
            }

            TTC.showLoading();
            
            try {
                const result = await TTC.deleteMatch(matchId, player1Id, player2Id, winnerId);
                if (result) {
                    TTC.showAlert('Match deleted successfully!', 'success');
                    loadDashboardData();
                } else {
                    TTC.showAlert('Failed to delete match. Please try again.', 'danger');
                }
            } catch (error) {
                console.error('Error deleting match:', error);
                TTC.showAlert('Failed to delete match: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }

        function populatePlayerSelects() {
            const players = TTC.getPlayers();
            const selects = document.querySelectorAll('select[name="player1_id"], select[name="player2_id"]');
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Player</option>' +
                    players.map(player => `<option value="${player.id}">${player.name}</option>`).join('');
                select.value = currentValue;
            });
        }


        function setupEventListeners() {
            // Update winner options when players are selected
            document.querySelectorAll('select[name="player1_id"], select[name="player2_id"]').forEach(select => {
                select.addEventListener('change', updateWinnerOptions);
            });

            // Handle attendance updates
            document.querySelectorAll('.attendance-select').forEach(select => {
                select.addEventListener('change', handleAttendanceUpdate);
            });

            // Mark attendance for specific date
            document.querySelectorAll('.mark-attendance-btn').forEach(btn => {
                btn.addEventListener('click', markAttendanceForDate);
            });

            // Handle add match form
            document.getElementById('addMatchForm').addEventListener('submit', handleAddMatch);

            // Handle edit player buttons
            document.querySelectorAll('.edit-player-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playerId = this.dataset.playerId;
                    const playerName = this.dataset.playerName;
                    const playerRank = this.dataset.playerRank;
                    editPlayer(playerId, playerName, playerRank);
                });
            });

            // Handle delete player buttons
            document.querySelectorAll('.delete-player-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playerId = this.dataset.playerId;
                    const playerName = this.dataset.playerName;
                    deletePlayer(playerId, playerName);
                });
            });

            // Handle streak adjustment buttons
            document.querySelectorAll('.adjust-streak-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const playerId = this.dataset.playerId;
                    const playerName = this.dataset.playerName;
                    adjustPlayerStreak(playerId, playerName);
                });
            });

            // Handle logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    TTC.logout();
                });
            }

            // Handle add player button
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            if (addPlayerBtn) {
                addPlayerBtn.addEventListener('click', addPlayer);
            }

            // Handle update player button
            const updatePlayerBtn = document.getElementById('updatePlayerBtn');
            if (updatePlayerBtn) {
                updatePlayerBtn.addEventListener('click', updatePlayer);
            }

            // Handle show more matches button
            const showMoreMatchesBtn = document.getElementById('showMoreMatchesBtn');
            if (showMoreMatchesBtn) {
                showMoreMatchesBtn.addEventListener('click', toggleShowMoreMatches);
            }

            // Handle delete all matches button
            const deleteAllMatchesBtn = document.getElementById('deleteAllMatchesBtn');
            if (deleteAllMatchesBtn) {
                deleteAllMatchesBtn.addEventListener('click', deleteAllMatches);
            }

            // Handle bulk streak adjustment button
            const bulkStreakAdjustBtn = document.getElementById('bulkStreakAdjustBtn');
            if (bulkStreakAdjustBtn) {
                bulkStreakAdjustBtn.addEventListener('click', bulkStreakAdjustment);
            }

            // Handle individual match delete buttons
            const deleteMatchBtns = document.querySelectorAll('.delete-match-btn');
            console.log('Found delete match buttons:', deleteMatchBtns.length);
            deleteMatchBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const matchId = this.dataset.matchId;
                    const player1Id = this.dataset.player1Id;
                    const player2Id = this.dataset.player2Id;
                    const winnerId = this.dataset.winnerId;
                    console.log('Delete match clicked:', matchId);
                    deleteMatch(matchId, player1Id, player2Id, winnerId);
                });
            });
        }

        function updateWinnerOptions() {
            const player1Id = document.querySelector('select[name="player1_id"]').value;
            const player2Id = document.querySelector('select[name="player2_id"]').value;
            const winnerSelect = document.querySelector('select[name="winner_id"]');
            
            winnerSelect.innerHTML = '<option value="">Select Winner</option>';
            
            if (player1Id && player2Id) {
                const player1Name = document.querySelector('select[name="player1_id"] option:checked').textContent;
                const player2Name = document.querySelector('select[name="player2_id"] option:checked').textContent;
                
                winnerSelect.innerHTML += `<option value="${player1Id}">${player1Name}</option>`;
                winnerSelect.innerHTML += `<option value="${player2Id}">${player2Name}</option>`;
            }
        }

        function handleAttendanceUpdate(event) {
            const playerId = event.target.dataset.playerId;
            const status = event.target.value;
            
            TTC.showLoading();
            
            setTimeout(async () => {
                const result = await TTC.updatePlayerAttendance(playerId, status);
                if (result) {
                    TTC.showAlert('Attendance updated successfully!', 'success');
                    loadPlayers(); // Refresh the players table to show updated attendance
                    loadStats(); // Refresh stats to update present count
                } else {
                    TTC.showAlert('Failed to update attendance. Please try again.', 'danger');
                }
                TTC.hideLoading();
            }, 300);
        }


        function markAttendanceForDate(event) {
            const playerId = event.target.dataset.playerId;
            const dateInput = document.querySelector(`.attendance-date[data-player-id="${playerId}"]`);
            const statusSelect = document.querySelector(`.attendance-select[data-player-id="${playerId}"]`);
            
            const date = dateInput.value;
            const status = statusSelect.value;
            
            if (!date) {
                TTC.showAlert('Please select a date', 'danger');
                return;
            }
            
            TTC.showLoading();
            
            setTimeout(async () => {
                const result = await TTC.updatePlayerAttendance(playerId, status, date);
                if (result) {
                    TTC.showAlert(`Attendance marked as ${status} for ${date}`, 'success');
                    
                    // Hide date controls
                    const dateControls = document.querySelector(`.attendance-date-controls[data-player-id="${playerId}"]`);
                    dateControls.style.display = 'none';
                    
                    loadPlayers(); // Refresh the players table to show updated attendance
                    loadStats(); // Refresh stats to update present count
                } else {
                    TTC.showAlert('Failed to mark attendance. Please try again.', 'danger');
                }
                TTC.hideLoading();
            }, 300);
        }

        async function handleAddMatch(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const matchData = {
                player1_id: formData.get('player1_id'),
                player2_id: formData.get('player2_id'),
                player1_score: parseInt(formData.get('player1_score')),
                player2_score: parseInt(formData.get('player2_score')),
                winner_id: formData.get('winner_id'),
                match_date: formData.get('match_date')
            };
            
            console.log('Adding match with data:', matchData);
            TTC.showLoading();
            
            try {
                const newMatch = await TTC.addMatch(matchData);
                if (newMatch) {
                    TTC.showAlert('Match added successfully!', 'success');
                    event.target.reset();
                    loadDashboardData();
                } else {
                    TTC.showAlert('Failed to add match - no match returned', 'danger');
                }
            } catch (error) {
                console.error('Failed to add match:', error);
                TTC.showAlert(`Failed to add match: ${error.message}`, 'danger');
            }
            TTC.hideLoading();
        }

        function addPlayer() {
            const form = document.getElementById('addPlayerForm');
            const formData = new FormData(form);
            
            const playerData = {
                name: formData.get('name'),
                email: formData.get('email'),
                username: formData.get('username'),
                password: formData.get('password'),
                rank: parseInt(formData.get('rank'))
            };
            
            TTC.showLoading();
            
            setTimeout(() => {
                TTC.addPlayer(playerData);
                TTC.showAlert('Player added successfully!', 'success');
                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide();
                loadDashboardData();
                TTC.hideLoading();
            }, 500);
        }

        function editPlayer(playerId, playerName, playerRank) {
            const player = TTC.getPlayerById(playerId);
            if (!player) {
                console.error('Player not found:', playerId);
                TTC.showAlert('Player not found', 'danger');
                return;
            }
            
            document.getElementById('editPlayerId').value = playerId;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerRank').value = player.rank;
            document.getElementById('editPlayerWins').value = player.wins;
            document.getElementById('editPlayerLosses').value = player.losses;
            document.getElementById('editPlayerStreak').value = player.current_streak || 0;
            
            const modal = new bootstrap.Modal(document.getElementById('editPlayerModal'));
            modal.show();
        }

        async function updatePlayer() {
            const form = document.getElementById('editPlayerForm');
            const formData = new FormData(form);
            
            const updateData = {
                name: formData.get('name'),
                rank: parseInt(formData.get('rank')),
                wins: parseInt(formData.get('wins')),
                losses: parseInt(formData.get('losses')),
                current_streak: parseInt(formData.get('current_streak'))
            };
            
            TTC.showLoading();
            
            try {
                console.log('CALL 5: admin dashboard calling updatePlayer');
                const result = await TTC.updatePlayer(formData.get('player_id'), updateData);
                if (result) {
                    TTC.showAlert('Player updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editPlayerModal')).hide();
                    loadDashboardData();
                } else {
                    TTC.showAlert('Failed to update player. Please try again.', 'danger');
                }
            } catch (error) {
                console.error('Error updating player:', error);
                TTC.showAlert('Failed to update player: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }

        async function deletePlayer(playerId, playerName) {
            if (!confirm(`Are you sure you want to delete player "${playerName}"? This action cannot be undone.`)) {
                return;
            }
            
            TTC.showLoading();
            
            try {
                const result = await TTC.deletePlayer(playerId);
                if (result) {
                    TTC.showAlert('Player deleted successfully!', 'success');
                    loadDashboardData();
                } else {
                    TTC.showAlert('Failed to delete player. Please try again.', 'danger');
                }
            } catch (error) {
                console.error('Error deleting player:', error);
                TTC.showAlert('Failed to delete player: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }

        async function adjustPlayerStreak(playerId, playerName) {
            const player = TTC.getPlayerById(playerId);
            if (!player) {
                TTC.showAlert('Player not found', 'danger');
                return;
            }

            // Create a simple prompt for streak adjustment
            const adjustment = prompt(
                `Quick Streak Adjustment for ${playerName}\n\n` +
                `Current streak: ${player.current_streak || 0}\n\n` +
                `Enter positive number to increase winning streak (+)\n` +
                `Enter negative number to increase losing streak (-)\n` +
                `Enter 0 to reset streak\n\n` +
                `Examples:\n` +
                `+3 = Add 3 to winning streak\n` +
                `-2 = Subtract 2 from streak (decrease winning or increase losing)`,
                '0'
            );

            if (adjustment === null) return; // User cancelled

            const streakAdjustment = parseInt(adjustment);
            if (isNaN(streakAdjustment)) {
                TTC.showAlert('Please enter a valid number (positive, negative, or 0)', 'danger');
                return;
            }

            const newStreak = (player.current_streak || 0) + streakAdjustment;

            // Confirm the adjustment
            const confirmMsg = `Confirm streak adjustment for ${playerName}?\n\n` +
                `Current: ${player.current_streak || 0}\n` +
                `Adjustment: ${streakAdjustment > 0 ? '+' : ''}${streakAdjustment}\n` +
                `New streak: ${newStreak}`;

            if (!confirm(confirmMsg)) return;

            TTC.showLoading();

            try {
                const result = await TTC.updatePlayer(playerId, { current_streak: newStreak });
                if (result) {
                    TTC.showAlert(
                        `${playerName}'s streak updated: ${player.current_streak || 0} → ${newStreak}`, 
                        'success'
                    );
                    loadPlayers(); // Refresh the players table
                } else {
                    TTC.showAlert('Failed to update streak. Please try again.', 'danger');
                }
            } catch (error) {
                console.error('Error updating streak:', error);
                TTC.showAlert('Failed to update streak: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }

        async function bulkStreakAdjustment() {
            const players = TTC.getPlayers();
            if (players.length === 0) {
                TTC.showAlert('No players found to adjust', 'info');
                return;
            }

            // Show current streaks
            let streakList = 'Current Player Streaks:\n\n';
            players.forEach(player => {
                streakList += `${player.name}: ${player.current_streak || 0}\n`;
            });

            const adjustmentType = prompt(
                `Bulk Streak Adjustment\n\n${streakList}\n` +
                `Choose adjustment type:\n` +
                `1. Add to ALL players (e.g., +5)\n` +
                `2. Set ALL players to same value (e.g., 0)\n` +
                `3. Reset ALL streaks to 0\n\n` +
                `Enter number or adjustment command:`,
                ''
            );

            if (!adjustmentType) return;

            let adjustmentValue;
            let operation = 'set';

            if (adjustmentType === '1' || adjustmentType.toLowerCase().includes('add')) {
                const addValue = prompt('Enter value to add to ALL streaks:', '0');
                adjustmentValue = parseInt(addValue);
                operation = 'add';
            } else if (adjustmentType === '2' || adjustmentType.toLowerCase().includes('set')) {
                const setValue = prompt('Enter value to set ALL streaks to:', '0');
                adjustmentValue = parseInt(setValue);
                operation = 'set';
            } else if (adjustmentType === '3' || adjustmentType.toLowerCase().includes('reset')) {
                adjustmentValue = 0;
                operation = 'set';
            } else {
                // Try to parse as direct number
                adjustmentValue = parseInt(adjustmentType);
                if (isNaN(adjustmentValue)) {
                    TTC.showAlert('Invalid input. Please enter a number.', 'danger');
                    return;
                }
                operation = 'set';
            }

            if (isNaN(adjustmentValue)) {
                TTC.showAlert('Invalid number entered.', 'danger');
                return;
            }

            const confirmMsg = `Confirm bulk streak adjustment?\n\n` +
                `Operation: ${operation}\n` +
                `Players: ${players.length}\n` +
                `Adjustment: ${operation === 'add' ? 
                    `Add ${adjustmentValue} to each streak` : 
                    `Set all streaks to ${adjustmentValue}`}\n\n` +
                `This will update ${players.length} players.`;

            if (!confirm(confirmMsg)) return;

            TTC.showLoading();

            try {
                let successCount = 0;
                for (const player of players) {
                    const currentStreak = player.current_streak || 0;
                    const newStreak = operation === 'add' ? 
                        currentStreak + adjustmentValue : 
                        adjustmentValue;

                    const result = await TTC.updatePlayer(player.id, { current_streak: newStreak });
                    if (result) successCount++;
                }

                if (successCount === players.length) {
                    TTC.showAlert(
                        `Successfully updated streaks for all ${players.length} players!`, 
                        'success'
                    );
                    loadPlayers(); // Refresh the table
                } else {
                    TTC.showAlert(
                        `Updated ${successCount} of ${players.length} players. Some updates failed.`, 
                        'warning'
                    );
                }
            } catch (error) {
                console.error('Error in bulk streak adjustment:', error);
                TTC.showAlert('Bulk streak update failed: ' + error.message, 'danger');
            } finally {
                TTC.hideLoading();
            }
        }
    </script>
</body>
</html>
