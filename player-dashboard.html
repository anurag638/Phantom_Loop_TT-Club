<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Dashboard - Phantom Loop TT Club</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <div class="logo-container"></div>
                <span class="navbar-brand-text">Phantom Loop TT Club</span>
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="welcomeText">
                    Welcome, Player
                </span>
                <a class="btn btn-outline-danger btn-sm" href="#" onclick="TTC.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-white mb-4" id="playerWelcome">
                    <i class="fas fa-user"></i> Welcome, Player
                </h1>
            </div>
        </div>

        <!-- Player Stats -->
        <div class="row mb-4" id="playerStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="row">
            <!-- Personal Performance -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i> Your Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="performance-stat">
                                    <div class="stat-number" id="totalWins">0</div>
                                    <div class="stat-label">Total Wins</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="performance-stat">
                                    <div class="stat-number" id="totalLosses">0</div>
                                    <div class="stat-label">Total Losses</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" id="winRateBar" style="width: 0%">
                                    <span id="winRateText">0% Win Rate</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                Current Rank: <strong id="currentRank">#0</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Leaderboard -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-crown"></i> Global Leaderboard
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="leaderboardTable">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th>Wins</th>
                                        <th>Win Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Leaderboard will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Attendance -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-check"></i> Club Attendance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Status</th>
                                        <th>Last Seen</th>
                                        <th>Rank</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Attendance Calendar -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt"></i> Your Attendance History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 col-md-7">
                                <div id="attendanceCalendar"></div>
                            </div>
                            <div class="col-lg-6 col-md-5">
                                <div class="attendance-summary">
                                    <h6 class="mb-3">Attendance Summary</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="attendance-stat present">
                                                <div class="stat-number" id="totalPresent">0</div>
                                                <div class="stat-label">Present</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="attendance-stat absent">
                                                <div class="stat-number" id="totalAbsent">0</div>
                                                <div class="stat-label">Absent</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="attendance-rate">
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     id="attendanceRate" style="width: 0%">
                                                    <span id="attendancePercentage">0%</span>
                                                </div>
                                            </div>
                                            <small class="text-muted">Attendance Rate</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <h6>Legend:</h6>
                                        <div class="legend">
                                            <span class="legend-item present">
                                                <i class="fas fa-circle"></i> Present
                                            </span>
                                            <span class="legend-item absent">
                                                <i class="fas fa-circle"></i> Absent
                                            </span>
                                            <span class="legend-item future">
                                                <i class="fas fa-circle"></i> Future
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Performance Chart -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie"></i> Your Performance Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Win/Loss Ratio</h6>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar bg-success" role="progressbar" id="winLossBar" style="width: 0%">
                                        <span id="winLossText">0% Wins</span>
                                    </div>
                                    <div class="progress-bar bg-danger" role="progressbar" id="lossBar" style="width: 0%">
                                        <span id="lossText">0% Losses</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Current Status</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h4 text-primary" id="rankDisplay">0</div>
                                            <small class="text-muted">Current Rank</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h4" id="streakDisplay">0</div>
                                            <small class="text-muted">Streak</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        // Check authentication
        if (!TTC.checkAuth()) {
            // Redirect will happen in checkAuth
        }

        // Global variables for calendar
        let attendanceData = {};
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        function initPlayerDashboard() {
            const user = TTC.getCurrentUser();
            document.getElementById('welcomeText').textContent = `Welcome, ${user.username} (${user.role})`;
            loadPlayerDashboard();
            setupEventListeners();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initPlayerDashboard();
        });

        // Also re-render after Firebase initial load
        document.addEventListener('ttc:dataLoaded', function() {
            initPlayerDashboard();
        });

        function loadPlayerDashboard() {
            const user = TTC.getCurrentUser();
            const player = TTC.getPlayerById(user.playerId);
            
            if (!player) {
                TTC.showAlert('Player data not found', 'danger');
                return;
            }
            
            // Update welcome message
            document.getElementById('playerWelcome').innerHTML = 
                `<i class="fas fa-user"></i> Welcome, ${player.name}`;
            
            loadPlayerStats(player);
            loadLeaderboard(player);
            loadAttendanceTable(player);
            loadAttendanceCalendar(player);
            loadPerformanceSummary(player);
        }

        function loadPlayerStats(player) {
            const statsHtml = `
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-number">${player.wins}</div>
                        <div class="stat-label">Wins</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="stat-number">${player.losses}</div>
                        <div class="stat-label">Losses</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-number">
                            ${player.current_streak > 0 ? '+' + player.current_streak : player.current_streak}
                        </div>
                        <div class="stat-label">Current Streak</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-number">${TTC.formatWinRate(player.win_rate)}%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                </div>
            `;
            
            document.getElementById('playerStats').innerHTML = statsHtml;
        }

        function loadLeaderboard(currentPlayer) {
            const players = TTC.getPlayers().sort((a, b) => b.wins - a.wins);
            const tbody = document.querySelector('#leaderboardTable tbody');
            
            tbody.innerHTML = players.slice(0, 5).map((player, index) => `
                <tr ${player.id === currentPlayer.id ? 'class="table-primary"' : ''}>
                    <td>
                        ${index === 0 ? '<i class="fas fa-crown text-warning"></i>' :
                          index === 1 ? '<i class="fas fa-medal text-secondary"></i>' :
                          index === 2 ? '<i class="fas fa-award text-warning"></i>' :
                          `<span class="badge badge-info">${index + 1}</span>`
                        }
                    </td>
                    <td>
                        <strong>${player.name}</strong>
                        ${player.id === currentPlayer.id ? '<span class="badge badge-primary">You</span>' : ''}
                    </td>
                    <td>${player.wins}</td>
                    <td>${TTC.formatWinRate(player.win_rate)}%</td>
                </tr>
            `).join('');
        }

        function loadAttendanceTable(currentPlayer) {
            const players = TTC.getPlayers();
            const tbody = document.querySelector('#attendanceTable tbody');
            
            tbody.innerHTML = players.map(player => `
                <tr ${player.id === currentPlayer.id ? 'class="table-primary"' : ''}>
                    <td>
                        <strong>${player.name}</strong>
                        ${player.id === currentPlayer.id ? '<span class="badge badge-primary">You</span>' : ''}
                    </td>
                    <td>
                        ${player.attendance_status === 'Present' ? 
                            '<span class="badge badge-success">Present</span>' :
                            '<span class="badge badge-danger">Absent</span>'
                        }
                    </td>
                    <td>${TTC.formatDate(player.last_seen)}</td>
                    <td>
                        <span class="badge badge-info">${player.rank}</span>
                    </td>
                </tr>
            `).join('');
        }

        function loadAttendanceCalendar(currentPlayer) {
            attendanceData = {};
            const attendanceRecords = TTC.getPlayerAttendanceHistory(currentPlayer.id, currentYear, currentMonth);
            
            attendanceRecords.forEach(record => {
                attendanceData[record.date] = record.status;
            });
            
            initializeCalendar();
            updateAttendanceSummary();
        }

        function loadPerformanceSummary(currentPlayer) {
            // Update performance stats
            document.getElementById('totalWins').textContent = currentPlayer.wins;
            document.getElementById('totalLosses').textContent = currentPlayer.losses;
            document.getElementById('currentRank').textContent = `#${currentPlayer.rank}`;
            
            // Update win rate bar
            const winRateBar = document.getElementById('winRateBar');
            const winRateText = document.getElementById('winRateText');
            winRateBar.style.width = `${currentPlayer.win_rate}%`;
            winRateText.textContent = `${TTC.formatWinRate(currentPlayer.win_rate)}% Win Rate`;
            
            // Update win/loss ratio
            const winLossBar = document.getElementById('winLossBar');
            const lossBar = document.getElementById('lossBar');
            const winLossText = document.getElementById('winLossText');
            const lossText = document.getElementById('lossText');
            
            winLossBar.style.width = `${currentPlayer.win_rate}%`;
            lossBar.style.width = `${100 - currentPlayer.win_rate}%`;
            winLossText.textContent = `${TTC.formatWinRate(currentPlayer.win_rate)}% Wins`;
            lossText.textContent = `${TTC.formatWinRate(100 - currentPlayer.win_rate)}% Losses`;
            
            // Update rank and streak displays
            document.getElementById('rankDisplay').textContent = currentPlayer.rank;
            const streakDisplay = document.getElementById('streakDisplay');
            streakDisplay.textContent = currentPlayer.current_streak > 0 ? 
                '+' + currentPlayer.current_streak : currentPlayer.current_streak;
            
            // Color code the streak
            if (currentPlayer.current_streak > 0) {
                streakDisplay.className = 'h4 text-success';
            } else if (currentPlayer.current_streak < 0) {
                streakDisplay.className = 'h4 text-danger';
            } else {
                streakDisplay.className = 'h4 text-warning';
            }
        }

        function setupEventListeners() {
            // Add hover effects to stat cards
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        function initializeCalendar() {
            const calendarContainer = document.getElementById('attendanceCalendar');
            calendarContainer.innerHTML = generateCalendarHTML();
            
            // Add event listeners for navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                // Render fresh using loader function only (avoid double innerHTML writes)
                const user = TTC.getCurrentUser();
                const player = TTC.getPlayerById(user.playerId);
                loadAttendanceCalendar(player);
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                const user = TTC.getCurrentUser();
                const player = TTC.getPlayerById(user.playerId);
                loadAttendanceCalendar(player);
            });
        }

        function generateCalendarHTML() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 class="calendar-title">${monthNames[currentMonth]} ${currentYear}</h3>
                    <button class="calendar-nav" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid">
            `;
            
            // Add day headers
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                const prevMonthDay = new Date(currentYear, currentMonth, 0).getDate() - startingDay + i + 1;
                html += `<div class="calendar-day other-month">${prevMonthDay}</div>`;
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const today = new Date();
                const isToday = currentYear === today.getFullYear() && 
                               currentMonth === today.getMonth() && 
                               day === today.getDate();
                const currentDateObj = new Date(currentYear, currentMonth, day);
                const isFuture = currentDateObj > today;
                
                let dayClass = 'calendar-day current-month';
                let attendanceStatus = '';
                
                const recorded = attendanceData[dateStr];
                if (recorded === 'Present') {
                    dayClass += ' present';
                    attendanceStatus = 'Present';
                } else if (recorded === 'Absent') {
                    dayClass += ' absent';
                    attendanceStatus = 'Absent';
                } else if (isToday) {
                    // If today and player currently marked Present, show green
                    const user = TTC.getCurrentUser();
                    const player = TTC.getPlayerById(user.playerId);
                    if (player && player.attendance_status === 'Present') {
                        dayClass += ' present';
                        attendanceStatus = 'Present';
                    } else {
                        dayClass += ' today';
                        attendanceStatus = 'Today';
                    }
                } else if (isFuture) {
                    dayClass += ' future';
                    attendanceStatus = 'Future';
                } else {
                    dayClass += ' no-data';
                }
                
                html += `<div class="${dayClass}" data-date="${dateStr}" data-status="${attendanceStatus}">${day}</div>`;
            }
            
            html += '</div>';
            return html;
        }

        function updateAttendanceSummary() {
            const presentDays = Object.values(attendanceData).filter(status => status === 'Present').length;
            const absentDays = Object.values(attendanceData).filter(status => status === 'Absent').length;
            const totalDays = presentDays + absentDays;
            const attendanceRate = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
            
            document.getElementById('totalPresent').textContent = presentDays;
            document.getElementById('totalAbsent').textContent = absentDays;
            document.getElementById('attendanceRate').style.width = `${attendanceRate}%`;
            document.getElementById('attendancePercentage').textContent = `${attendanceRate}%`;
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            console.log('Dashboard data refreshed');
        }, 30000);
    </script>
</body>
</html>
